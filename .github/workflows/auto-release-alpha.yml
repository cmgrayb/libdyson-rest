name: "Auto-Release: Alpha"

on:
  push:
    branches:
      - "release/alpha"
  workflow_dispatch:
    inputs:
      force_version:
        description: 'Force specific version (optional)'
        required: false
        type: string

permissions:
  contents: write
  id-token: write
  pull-requests: read

env:
  PYTHON_VERSION: "3.11"

jobs:
  auto-release-alpha:
    name: "ðŸš€ Auto-Release Alpha"
    runs-on: ubuntu-latest
    environment: testpypi
    
    # Skip only explicit [skip-release] commits 
    # Note: We don't skip auto-release commits here because the workflow has safeguards
    # to detect recent releases and prevent actual loops in the version increment step
    if: |
      github.event_name == 'workflow_dispatch' || 
      (github.event_name == 'push' && 
       !contains(github.event.head_commit.message, '[skip-release]') &&
       !contains(github.ref, 'refs/pull/'))
    
    steps:
      - name: "ðŸ“¥ Checkout repository"
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.RELEASE_TOKEN }}

      - name: "ðŸ” Verify Not Auto-Release Loop"
        run: |
          echo "ðŸ” Checking commit details to prevent infinite loops..."
          echo "Commit message: ${{ github.event.head_commit.message }}"
          echo "Author: ${{ github.event.head_commit.author.name }} (${{ github.event.head_commit.author.email }})"
          echo "Committer: ${{ github.event.head_commit.committer.name }} (${{ github.event.head_commit.committer.email }})"
          
          # Simple check: Only fail if this is a direct auto-release commit from GitHub Action
          if [[ "${{ github.event.head_commit.message }}" == *"ðŸš€ Auto-release: Bump to v"* ]] && [[ "${{ github.event.head_commit.author.email }}" == "action@github.com" ]]; then
            echo "âŒ This is a direct auto-release commit from GitHub Action - preventing loop."
            exit 1
          fi
          
          echo "âœ… Loop prevention checks passed. Proceeding with alpha release."

      - name: "ï¿½ðŸ Set up Python"
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: "ðŸ“¦ Install dependencies"
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements-dev.txt
          pip install -e .

      - name: "â±ï¸ Check for Recent Alpha Releases"
        id: time_check
        run: |
          echo "ðŸ” Checking for recent alpha releases to prevent rapid-fire releases..."
          
          # Get the latest alpha tag
          LATEST_ALPHA_TAG=$(git tag -l "v*a*" --sort=-version:refname | head -n 1)
          
          if [ -n "$LATEST_ALPHA_TAG" ]; then
            echo "Latest alpha tag: $LATEST_ALPHA_TAG"
            
            # Get the timestamp of the latest alpha tag
            TAG_TIME=$(git log -1 --format=%ct "$LATEST_ALPHA_TAG")
            CURRENT_TIME=$(date +%s)
            TIME_DIFF=$((CURRENT_TIME - TAG_TIME))
            
            echo "Tag created $TIME_DIFF seconds ago"
            
            # If the latest alpha was created less than 5 minutes ago, mark for skip
            if [ $TIME_DIFF -lt 300 ]; then
              echo "âœ… Latest alpha release was created less than 5 minutes ago."
              echo "This prevents rapid-fire releases and potential loops."
              echo "Marking remaining steps to be skipped - this is expected behavior."
              echo "should_skip=true" >> $GITHUB_OUTPUT
              exit 0
            fi
          fi
          
          echo "should_skip=false" >> $GITHUB_OUTPUT
          echo "âœ… No recent alpha releases detected. Proceeding with release."

      - name: "ðŸ§ª Run Tests"
        if: steps.time_check.outputs.should_skip == 'false'
        run: |
          python -m pytest tests/ -v --cov=src/ --cov-report=term-missing --cov-fail-under=80

      - name: "ðŸ“ Auto-increment Alpha Version"
        if: steps.time_check.outputs.should_skip == 'false'
        id: version
        run: |
          if [ -n "${{ github.event.inputs.force_version }}" ]; then
            NEW_VERSION="${{ github.event.inputs.force_version }}"
            echo "Using forced version: $NEW_VERSION"
            python scripts/update_version.py "$NEW_VERSION"
          else
            echo "Auto-incrementing alpha version..."
            python scripts/update_version.py --increment alpha
          fi
          
          # Get the new version
          NEW_VERSION=$(python scripts/update_version.py --show | grep -o '[0-9]\+\.[0-9]\+\.[0-9]\+[a-zA-Z0-9]*')
          echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "ðŸ“Œ New version: $NEW_VERSION"

      - name: "ðŸ’¾ Commit Version Update"
        if: steps.time_check.outputs.should_skip == 'false'
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add pyproject.toml
          git commit -m "ðŸš€ Auto-release: Bump to v${{ steps.version.outputs.new_version }}" || exit 0

      - name: "ðŸ·ï¸ Create Git Tag"
        if: steps.time_check.outputs.should_skip == 'false'
        run: |
          git tag -a "v${{ steps.version.outputs.new_version }}" -m "Alpha release v${{ steps.version.outputs.new_version }}"

      - name: "â¬†ï¸ Push Changes and Tags"
        if: steps.time_check.outputs.should_skip == 'false'
        run: |
          git push origin release/alpha
          git push origin "v${{ steps.version.outputs.new_version }}"

      - name: "ðŸ“¦ Build Package"
        if: steps.time_check.outputs.should_skip == 'false'
        run: |
          python -m pip install --upgrade build
          python -m build

      # Note: Publishing to TestPyPI is now handled by the publish-to-pypi.yml workflow
      # when the GitHub release is created. This prevents duplicate uploads.

      - name: "ðŸ“‹ Create GitHub Release"
        if: steps.time_check.outputs.should_skip == 'false'
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.RELEASE_TOKEN }}
        with:
          tag_name: "v${{ steps.version.outputs.new_version }}"
          release_name: "libdyson-rest v${{ steps.version.outputs.new_version }} (Alpha)"
          body: |
            ðŸ§ª **Alpha Release** - For testing purposes only
            
            **Version:** `${{ steps.version.outputs.new_version }}`
            **Published to:** TestPyPI
            **Branch:** `release/alpha`
            
            ## Installation
            ```bash
            pip install --index-url https://test.pypi.org/simple/ libdyson-rest==${{ steps.version.outputs.new_version }}
            ```
            
            ## âš ï¸ Alpha Notice
            This is an alpha release intended for testing. Features may be incomplete or unstable.
            
            ## ðŸ”„ Auto-Generated Release
            This release was automatically created by the alpha release pipeline.
          draft: false
          prerelease: true

      - name: "ðŸ“Š Release Summary"
        run: |
          echo "## ðŸŽ‰ Alpha Release Complete!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** \`${{ steps.version.outputs.new_version }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Target:** TestPyPI" >> $GITHUB_STEP_SUMMARY  
          echo "**Branch:** \`release/alpha\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“¦ Installation" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "pip install --index-url https://test.pypi.org/simple/ libdyson-rest==${{ steps.version.outputs.new_version }}" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ”— Links" >> $GITHUB_STEP_SUMMARY
          echo "- [TestPyPI Package](https://test.pypi.org/project/libdyson-rest/${{ steps.version.outputs.new_version }}/)" >> $GITHUB_STEP_SUMMARY
          echo "- [GitHub Release](https://github.com/${{ github.repository }}/releases/tag/v${{ steps.version.outputs.new_version }})" >> $GITHUB_STEP_SUMMARY

      - name: "â„¹ï¸ Release Skipped"
        if: steps.time_check.outputs.should_skip == 'true'
        run: |
          echo "## â­ï¸ Auto-Release Skipped" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Reason:** Recent alpha release detected (within 5 minutes)" >> $GITHUB_STEP_SUMMARY  
          echo "**Status:** âœ… This is expected behavior to prevent rapid-fire releases" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "The workflow completed successfully but skipped release steps to prevent loops." >> $GITHUB_STEP_SUMMARY
